<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NDIS Support Portal</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" xintegrity="sha512-Fo3rlrZj/k7ujTnHg4CGR2D7kSs0v4LLanw2qksYuRlEzO+tcaEPQogQ0KaoGN26/zrn20ImR1DfuLWnOo7aBA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  
  <link rel="stylesheet" href="style.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"
          xintegrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg=="
          crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

</head>
<body x-data="portalApp()">

<div id="authScreen" class="d-flex flex-column align-items-center justify-content-center vh-100 bg-light">
  <div class="auth-dialog-content p-4 p-md-5 rounded shadow-lg bg-white" style="max-width: 420px; width: 100%;"> 
      <h3 class="text-center mb-3 fw-bold"><i class="fas fa-user-lock me-2 text-primary"></i> NDIS Portal Access</h3>
      <p class="text-center mb-4 text-muted">Please sign in or register to continue.</p>
      <form id="authForm"> 
        <div class="mb-3">
          <label for="authEmail" class="form-label">Email</label> 
          <input type="email" class="form-control" id="authEmail" placeholder="email@example.com" />
        </div>
        <div class="mb-3">
          <label for="authPassword" class="form-label">Password</label> 
          <input type="password" class="form-control" id="authPassword" placeholder="••••••••" />
        </div>
        <div class="d-grid gap-2 d-sm-flex justify-content-sm-between mt-4">
          <button type="button" id="loginBtn" class="btn btn-primary flex-grow-1 mb-2 mb-sm-0">Login</button>
          <button type="button" id="registerBtn" class="btn btn-outline-secondary flex-grow-1">Register</button>
        </div>
      </form> 
      <div id="authStatusMessage" class="mt-3 text-center text-danger"></div>
    </div>
</div>

<div id="portalApp" class="d-none"> <div class="d-flex vh-100">
    <nav id="side" class="d-none d-md-flex flex-column p-3 bg-dark text-white" style="width: 260px;">
      <h1 id="portalTitleDisplay" class="fs-4 text-center pb-2 mb-3 border-bottom border-secondary"><i class="fas fa-cogs me-2"></i>NDIS Portal</h1>
      <ul class="nav nav-pills flex-column mb-auto">
        <li class="nav-item"><a href="#home" class="nav-link text-white active" data-section="home"><i class="fas fa-home me-2"></i>Home</a></li>
        <li class="nav-item"><a href="#profile" class="nav-link text-white d-none" data-section="profile"><i class="fas fa-user-circle me-2"></i>Profile</a></li>
        <li class="nav-item"><a href="#invoice" class="nav-link text-white d-none" data-section="invoice"><i class="fas fa-file-invoice-dollar me-2"></i>Invoice</a></li>
        <li class="nav-item"><a href="#agreement" class="nav-link text-white d-none" data-section="agreement"><i class="fas fa-file-signature me-2"></i>Agreement</a></li>
        <li class="nav-item"><a href="#admin" class="nav-link text-white d-none" id="adminTab" data-section="admin"><i class="fas fa-user-shield me-2"></i>Admin</a></li>
      </ul>
      <hr class="text-secondary">
      <button id="logoutBtn" class="btn btn-outline-light btn-sm d-none w-100"><i class="fas fa-sign-out-alt me-2"></i>Logout</button>
    </nav>

    <main class="flex-grow-1 p-3 p-md-4 overflow-auto bg-light">
      <div id="loadingOverlay" class="modal fade" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered justify-content-center border-0">
            <div class="text-white text-center bg-transparent">
                <i class="fas fa-spinner fa-spin fa-3x"></i>
                <p class="mt-2 fs-5">Loading...</p>
            </div>
        </div>
      </div>

      <section id="home" class="card mb-4 shadow-sm active">
        <div class="card-body">
          <h2 class="card-title"><i class="fas fa-door-open me-2"></i>Welcome</h2>
          <div id="authStatus" class="mb-3 fst-italic">
              User ID: <span id="userIdDisplay" class="fw-bold">Not Logged In</span>
          </div>
          <div id="homeUser" class="d-none"> 
            <p class="fs-5">Welcome back, <span id="userNameDisplay" class="fw-semibold">User</span>!</p>
            <div class="d-grid gap-3 mt-4">
                  <button id="rqBtn" class="btn btn-primary btn-lg"><i class="fas fa-calendar-plus me-2"></i>Request a Shift</button>
                  <button id="logTodayShiftBtn" class="btn btn-success btn-lg"><i class="fas fa-clipboard-list me-2"></i>Log New Shift</button>
            </div>
            <div id="shiftRequestsContainer" class="d-none mt-4 p-3 bg-light-subtle rounded border">
              <h5><i class="fas fa-tasks me-2"></i>Shift Requests</h5>
              <div class="table-responsive">
                <table id="rqTbl" class="table table-striped table-sm">
                  <thead><tr><th>Date</th><th>Start</th><th>End</th><th>Reason</th><th>Status</th></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section id="profile" class="card mb-4 shadow-sm">
        <div class="card-body">
          <h2 class="card-title"><i class="fas fa-id-card me-2"></i>Your Profile</h2>
          <div id="profileDetails" class="p-3 bg-light-subtle rounded border mb-3">
            <p><strong><i class="fas fa-user-tag me-1"></i>Name:</strong> <span id="profileName"></span></p>
            <p><strong><i class="fas fa-briefcase me-1"></i>ABN:</strong> <span id="profileAbn"></span></p>
            <p><strong><i class="fas fa-percent me-1"></i>GST Registered:</strong> <span id="profileGst"></span></p>
            <p><strong><i class="fas fa-landmark me-1"></i>BSB:</strong> <span id="profileBsb"></span></p>
            <p><strong><i class="fas fa-credit-card me-1"></i>Account Number:</strong> <span id="profileAcc"></span></p>
          </div>
          <button id="editProfileBtn" class="btn btn-secondary mb-3"><i class="fas fa-edit me-2"></i>Edit Profile Details</button>
          <hr>
          <div class="p-3 bg-light-subtle rounded border">
              <h5><i class="fas fa-folder-open me-2"></i>Supporting Documents</h5>
              <div id="profileFilesDisplay" class="mb-3">
                  <p><strong>Uploaded Files:</strong></p>
                  <ul id="profileFilesList" class="list-group"></ul>
              </div>
              <div class="mb-3">
                  <label for="profileFileUpload" class="form-label"><i class="fas fa-file-upload me-2"></i>Upload New Document(s):</label>
                  <input type="file" class="form-control" id="profileFileUpload" multiple>
              </div>
              <button id="uploadProfileDocumentsBtn" class="btn btn-info text-white"><i class="fas fa-plus-circle me-2"></i>Add Document(s)</button>
          </div>
        </div>
      </section>

      <section id="invoice" class="card mb-4 shadow-sm">
        <div class="card-body">
          <h2 class="card-title"><i class="fas fa-calculator me-2"></i>Invoice – Week <span id="wkLbl"></span></h2>
          <div id="invoicePdfContent">
              <div class="row g-3 mb-3">
                <div class="col-md-6"><label for="invNo" class="form-label">Invoice #</label><input id="invNo" class="form-control" readonly></div>
                <div class="col-md-6"><label for="invDate" class="form-label">Date issued</label><input type="text" id="invDate" class="form-control flatpickr-date"></div>
              </div>
              <div class="row g-3 mb-3" id="providerDetailsRow">
                <div class="col-md-6"><label for="provName" class="form-label">Provider (your name)</label><input id="provName" class="form-control" readonly></div>
                <div class="col-md-6"><label for="provAbn" class="form-label">ABN</label><input id="provAbn" class="form-control" readonly></div>
                <div class="col-md-12">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="gstFlag" disabled>
                        <label class="form-check-label" for="gstFlag">GST Registered</label>
                    </div>
                </div>
              </div>
              <div class="table-responsive mb-3">
                <table id="invTbl" class="table table-bordered table-hover">
                  <thead class="table-light">
                    <tr>
                        <th>#</th><th>Date <span class="date-print-value d-none"></span></th>
                        <th class="column-code d-none d-print-table-cell">Code <span class="code-print-value d-none"></span></th> 
                        <th>Description <span class="description-print-value d-none"></span></th>
                        <th>Start <span class="start-time-print-value d-none"></span></th>
                        <th>End <span class="end-time-print-value d-none"></span></th>
                        <th class="column-rate-type d-none d-print-table-cell">Rate type <span class="rate-type-print-value d-none"></span></th> 
                        <th class="d-none d-print-table-cell">Rate/Unit ($) <span class="rate-unit-print-value d-none"></span></th> 
                        <th>Hours/Km <span class="hours-km-print-value d-none"></span></th> 
                        <th class="d-print-none">Travel (Km)</th> <th class="d-print-none">Claim Travel</th> 
                        <th>Total ($) <span class="total-print-value d-none"></span></th>
                        <th class="d-print-none">Actions</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
              <div class="totals text-end fs-5">
                <div>Subtotal:  <b id="sub">$0.00</b></div>
                <div id="gstRow" class="d-none">GST 10 %:  <b id="gst">$0.00</b></div>
                <div>Total:  <b id="grand" class="fw-bold">$0.00</b></div>
              </div>
          </div> 
          <div class="mt-4">
              <button id="addInvRowUserActionBtn" class="btn btn-primary me-2"><i class="fas fa-plus me-2"></i>Add Service</button> 
              <button id="saveDraftBtn" class="btn btn-secondary me-2"><i class="fas fa-save me-2"></i>Save Draft</button>
              <button id="generateInvoicePdfBtn" class="btn btn-info text-white"><i class="fas fa-file-pdf me-2"></i>Download PDF</button> 
          </div>
        </div>
      </section>

      <section id="agreement" class="card mb-4 shadow-sm">
         <div class="card-body">
            <h2 id="agreementDynamicTitle" class="card-title"><i class="fas fa-handshake me-2"></i> Service Agreement</h2>
            <div id="adminAgreementWorkerSelector" class="mb-3 p-3 bg-light-subtle rounded border d-none">
                <h5><i class="fas fa-user-cog me-2"></i>Admin: View Agreement</h5>
                <label for="adminSelectWorkerForAgreement" class="form-label">Select Support Worker:</label>
                <div class="input-group">
                    <select id="adminSelectWorkerForAgreement" class="form-select">
                        <option value="">-- Select a Worker --</option>
                    </select>
                    <button id="loadServiceAgreementForSelectedWorkerBtn" class="btn btn-outline-secondary"><i class="fas fa-eye me-1"></i>Load</button>
                </div>
                <small class="form-text text-muted d-block mt-1">Participant details from Global Settings. Worker details/services from selected worker's profile.</small>
            </div>
            <div id="agrChip" class="badge bg-warning text-dark p-2 fs-6 mb-3">Draft – waiting for signatures</div>
            <div id="agreementContentWrapper" class="border p-3 rounded bg-white mb-3" style="min-height: 300px;"> 
                <div id="agreementHeaderForPdf" class="d-none text-center mb-3"></div>
                <div id="agreementContentContainer" class="agreement-content-view"></div>
            </div>
            <hr>
            <div class="signWrap row text-center mb-3">
              <div class="col-md-6"><b>Participant</b><br><img id="sigP" alt="Participant Signature Area" class="signature-image img-thumbnail mb-1" src="https://placehold.co/250x85/e8e8e8/666666?text=Signature+Area&txtsize=16"><br><span id="dP">___</span></div>
              <div class="col-md-6"><b>Support Worker</b><br><img id="sigW" alt="Support Worker Signature Area" class="signature-image img-thumbnail mb-1" src="https://placehold.co/250x85/e8e8e8/666666?text=Signature+Area&txtsize=16"><br><span id="dW">___</span></div>
            </div>
            <div class="agreement-actions">
                <button id="signBtn" class="btn btn-primary me-2"><i class="fas fa-signature me-2"></i>Sign Agreement</button>
                <button id="participantSignBtn" class="btn btn-primary me-2 d-none"><i class="fas fa-user-edit me-2"></i>Sign for Participant</button> 
                <button id="pdfBtn" class="btn btn-secondary d-none"><i class="fas fa-file-pdf me-2"></i>Download PDF</button>
            </div>
        </div>
      </section>

      <section id="admin" class="card mb-4 shadow-sm" x-data="{ activeTab: 'adminGlobalSettings' }">
        <div class="card-body">
            <h2 class="card-title"><i class="fas fa-tools me-2"></i>Admin Dashboard</h2>
            <ul class="nav nav-tabs mb-3">
                <li class="nav-item">
                    <button class="nav-link" :class="{ 'active': activeTab === 'adminGlobalSettings' }" @click="activeTab = 'adminGlobalSettings'"><i class="fas fa-globe-americas me-1"></i>Global Settings</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" :class="{ 'active': activeTab === 'adminServiceManagement' }" @click="activeTab = 'adminServiceManagement'"><i class="fas fa-concierge-bell me-1"></i>NDIS Services</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" :class="{ 'active': activeTab === 'adminAgreementCustomization' }" @click="activeTab = 'adminAgreementCustomization'"><i class="fas fa-file-alt me-1"></i>Agreement Template</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" :class="{ 'active': activeTab === 'adminWorkerManagement' }" @click="activeTab = 'adminWorkerManagement'"><i class="fas fa-users-cog me-1"></i>Worker Management</button>
                </li>
            </ul>

            <div x-show="activeTab === 'adminGlobalSettings'" class="admin-content-panel p-3 bg-light-subtle rounded border">
                <h5><i class="fas fa-cogs me-2"></i>Portal Global Settings</h5>
                <p>These settings affect the entire portal.</p>
                <div id="editPortalSettingsContainer">
                    <div class="mb-3 p-2 border rounded">
                        <h6><i class="fas fa-building me-1"></i>Organization Details</h6>
                        <div class="mb-2"><label for="adminEditOrgName" class="form-label-sm">Organization/Provider Name:</label><input id="adminEditOrgName" type="text" class="form-control form-control-sm"></div>
                        <div class="mb-2"><label for="adminEditOrgAbn" class="form-label-sm">Organization ABN:</label><input id="adminEditOrgAbn" type="text" class="form-control form-control-sm"></div>
                        <div class="mb-2"><label for="adminEditOrgContactEmail" class="form-label-sm">Primary Contact Email:</label><input id="adminEditOrgContactEmail" type="email" class="form-control form-control-sm"></div>
                        <div class="mb-2"><label for="adminEditOrgContactPhone" class="form-label-sm">Primary Contact Phone:</label><input id="adminEditOrgContactPhone" type="text" class="form-control form-control-sm"></div>
                    </div>
                    <div class="mb-3 p-2 border rounded">
                        <h6><i class="fas fa-child me-1"></i>Default Participant & Plan Details</h6>
                        <div class="mb-2"><label for="adminEditParticipantName" class="form-label-sm">Participant's Full Name:</label><input id="adminEditParticipantName" type="text" class="form-control form-control-sm"></div>
                        <div class="mb-2"><label for="adminEditParticipantNdisNo" class="form-label-sm">Participant's NDIS Number:</label><input id="adminEditParticipantNdisNo" type="text" class="form-control form-control-sm"></div>
                        <div class="mb-2"><label for="adminEditPlanManagerName" class="form-label-sm">Plan Manager Name:</label><input id="adminEditPlanManagerName" type="text" class="form-control form-control-sm"></div>
                        <div class="mb-2"><label for="adminEditPlanManagerEmail" class="form-label-sm">Plan Manager Email:</label><input id="adminEditPlanManagerEmail" type="email" class="form-control form-control-sm"></div>
                        <div class="mb-2"><label for="adminEditPlanManagerPhone" class="form-label-sm">Plan Manager Phone:</label><input id="adminEditPlanManagerPhone" type="text" class="form-control form-control-sm"></div>
                        <div class="mb-2"><label for="adminEditPlanEndDate" class="form-label-sm">Current Plan End Date:</label><input id="adminEditPlanEndDate" type="text" class="form-control form-control-sm flatpickr-date"></div>
                    </div>
                    <div class="mt-3">
                        <button id="saveAdminPortalSettingsBtn" class="btn btn-primary btn-sm me-2"><i class="fas fa-save me-1"></i>Save Settings</button>
                        <button id="resetGlobalSettingsToDefaultsBtn" class="btn btn-danger btn-sm" title="Resets all portal settings to their original defaults."><i class="fas fa-undo me-1"></i>Reset Defaults</button>
                    </div>
                </div>
                <hr>
                <p>Invite link for new support workers:</p>
                <div class="input-group mb-3">
                  <input type="text" id="invite" class="form-control form-control-sm" readonly>
                  <button id="copyLinkBtn" class="btn btn-outline-secondary btn-sm"><i class="fas fa-copy"></i></button>
                </div>
            </div>

            <div x-show="activeTab === 'adminServiceManagement'" class="admin-content-panel p-3 bg-light-subtle rounded border">
                <h5><i class="fas fa-list-alt me-2"></i>Manage NDIS Support Services</h5>
                <div class="mb-3 p-2 border rounded">
                    <h6><i class="fas fa-plus-square me-1"></i>Add/Edit Service</h6>
                    <input type="hidden" id="adminServiceId">
                    <div class="mb-2"><label for="adminServiceCode" class="form-label-sm">NDIS Item Code:</label><input type="text" id="adminServiceCode" class="form-control form-control-sm" placeholder="e.g., 01_011_0107_1_1"></div>
                    <div class="mb-2"><label for="adminServiceDescription" class="form-label-sm">Description:</label><input type="text" id="adminServiceDescription" class="form-control form-control-sm" placeholder="e.g., Assistance with Daily Life"></div>
                    <div class="mb-2"><label for="adminServiceCategoryType" class="form-label-sm">Service Category Type:</label>
                        <select id="adminServiceCategoryType" class="form-select form-select-sm">
                            <option value="core_standard">Core - Standard (Weekday/Evening/Night/Weekend/PH Rates)</option>
                            <option value="core_high_intensity">Core - High Intensity (Weekday/Evening/Night/Weekend/PH Rates)</option>
                            <option value="capacity_therapy_std">Capacity Building - Therapy Standard Rate</option>
                            <option value="capacity_specialist">Capacity Building - Specialist Rate</option>
                            <option value="travel_km">Travel - Per Kilometre</option>
                            <option value="other_flat_rate">Other - Single Flat Rate</option>
                        </select>
                    </div>
                    <div id="adminServiceRateFieldsContainer" class="mb-2"></div>
                    <div class="mb-2"><label for="adminServiceTravelCodeDisplay" class="form-label-sm">Associated Travel Item Code:</label>
                        <div class="input-group input-group-sm">
                            <input type="text" id="adminServiceTravelCodeDisplay" class="form-control form-control-sm" readonly placeholder="None selected">
                            <button id="selectTravelCodeBtn" class="btn btn-outline-secondary"><i class="fas fa-route"></i></button>
                        </div>
                        <input type="hidden" id="adminServiceTravelCode">
                        <small class="form-text text-muted">Select an existing NDIS Travel Item Code.</small>
                    </div>
                    <div class="mt-2">
                        <button id="saveAdminServiceBtn" class="btn btn-primary btn-sm me-2"><i class="fas fa-save me-1"></i>Save Service</button>
                        <button id="clearAdminServiceFormBtn" class="btn btn-secondary btn-sm"><i class="fas fa-eraser me-1"></i>Clear</button>
                    </div>
                </div>
                <h6><i class="fas fa-stream me-1"></i>Current Services</h6>
                <div class="table-responsive">
                    <table id="adminServicesTable" class="table table-sm table-striped table-bordered">
                        <thead><tr><th>Item Code</th><th>Description</th><th>Category</th><th>Primary Rate</th><th>Travel Code</th><th>Actions</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div x-show="activeTab === 'adminAgreementCustomization'" class="admin-content-panel p-3 bg-light-subtle rounded border">
                <h5><i class="fas fa-edit me-2"></i>Service Agreement Customization</h5>
                <p>Use placeholders like <code>{{participantName}}</code>, etc. <code>{{serviceList}}</code> will list worker's authorized services.</p>
                <div class="mb-2"><label for="adminAgreementOverallTitle" class="form-label-sm">Overall Agreement Title:</label><input type="text" id="adminAgreementOverallTitle" class="form-control form-control-sm" placeholder="e.g., NDIS Service Agreement"></div>
                <div id="adminAgreementClausesContainer" class="mb-2"></div>
                <div class="mt-2">
                    <button id="adminAddAgreementClauseBtn" class="btn btn-secondary btn-sm me-2"><i class="fas fa-plus-circle me-1"></i>Add Clause</button>
                    <button id="saveAdminAgreementCustomizationsBtn" class="btn btn-primary btn-sm"><i class="fas fa-save me-1"></i>Save Structure</button>
                </div>
                <hr>
                <h6><i class="fas fa-eye me-1"></i>Preview (Placeholders not filled here)</h6>
                <div id="adminAgreementPreview" class="p-2 border rounded bg-white" style="min-height: 100px;"></div>
            </div>
            
            <div x-show="activeTab === 'adminWorkerManagement'" class="admin-content-panel p-3 bg-light-subtle rounded border">
              <h5><i class="fas fa-id-badge me-2"></i>Worker Management</h5>
              <p>Manage service authorizations. Services must be defined in "NDIS Services" tab.</p>
              <hr class="my-3">
              <h6><i class="fas fa-user-shield me-1"></i>Service Authorizations for Workers</h6>
              <div class="row">
                  <div class="col-md-5 mb-3">
                      <label for="workersListForAuthSelect" class="form-label-sm">Select Worker:</label>
                      <select id="workersListForAuthSelect" class="form-select form-select-sm mb-2"></select>
                      </div>
                  <div class="col-md-7">
                      <div id="servicesForWorkerContainer" class="d-none">
                          <h6 id="selectedWorkerNameForAuth" class="mb-2">Manage Services for: </h6>
                          <p class="small">Check services this worker is authorized for:</p>
                          <div id="servicesListCheckboxes" class="list-group list-group-flush border rounded p-2" style="max-height: 300px; overflow-y:auto;">
                              </div>
                          <button id="saveWorkerAuthorizationsBtn" class="btn btn-primary btn-sm mt-3"><i class="fas fa-save me-1"></i>Save Authorizations</button>
                      </div>
                  </div>
              </div>
            </div>
        </div>
      </section>
    </main>
  </div>

  <nav id="bottom" class="d-md-none navbar fixed-bottom navbar-dark bg-dark">
    <div class="container-fluid d-flex justify-content-around">
      <a href="#home" class="nav-link text-white p-2 active" data-section="home" aria-label="Home"><i class="fas fa-home fs-4"></i></a>
      <a href="#profile" class="nav-link text-white p-2 d-none" data-section="profile" aria-label="Profile"><i class="fas fa-user-circle fs-4"></i></a>
      <a href="#invoice" class="nav-link text-white p-2 d-none" data-section="invoice" aria-label="Invoice"><i class="fas fa-file-invoice-dollar fs-4"></i></a>
      <a href="#agreement" class="nav-link text-white p-2 d-none" data-section="agreement" aria-label="Agreement"><i class="fas fa-file-signature fs-4"></i></a>
      <a href="#admin" id="adminBottomTab" class="nav-link text-white p-2 d-none" data-section="admin" aria-label="Admin"><i class="fas fa-user-shield fs-4"></i></a>
    </div>
  </nav>
</div> 

<div class="modal fade" id="setInitialInvoiceModal" tabindex="-1" aria-labelledby="setInitialInvoiceModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="setInitialInvoiceModalLabel"><i class="fas fa-file-invoice me-2"></i>Set Starting Invoice Number</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Please set your starting invoice number. This will auto-increment for future invoices.</p>
        <div class="mb-3">
            <label for="initialInvoiceNumberInput" class="form-label">Starting Invoice Number:</label>
            <input type="number" class="form-control" id="initialInvoiceNumberInput" placeholder="e.g., 1001">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" id="saveInitialInvoiceNumberBtn" class="btn btn-primary"><i class="fas fa-save me-2"></i>Save and Continue</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="rqModal" tabindex="-1" aria-labelledby="rqModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="rqModalLabel"><i class="fas fa-calendar-check me-2"></i>Request a Shift</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3"><label for="rqDate" class="form-label">Date</label><input type="text" id="rqDate" class="form-control flatpickr-date"></div>
        <div class="mb-3"><label for="rqStart" class="form-label">Start Time</label><input type="text" id="rqStart" class="form-control flatpickr-time" placeholder="Select Time"></div>
        <div class="mb-3"><label for="rqEnd" class="form-label">End Time</label><input type="text" id="rqEnd" class="form-control flatpickr-time" placeholder="Select Time"></div>
        <div class="mb-3"><label for="rqReason" class="form-label">Reason (Optional)</label><textarea id="rqReason" class="form-control" rows="3" placeholder="Enter reason..."></textarea></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="fas fa-times me-1"></i>Cancel</button>
        <button type="button" id="saveRequestBtn" class="btn btn-primary"><i class="fas fa-paper-plane me-1"></i>Submit</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="logShiftModal" tabindex="-1" aria-labelledby="logShiftModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="logShiftModalLabel"><i class="fas fa-user-clock me-2"></i>Log New Shift</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row g-3">
            <div class="col-md-6"><label for="logShiftDate" class="form-label">Date</label><input type="text" id="logShiftDate" class="form-control flatpickr-date"></div>
            <div class="col-md-6"><label for="logShiftSupportType" class="form-label">Support Type</label><select id="logShiftSupportType" class="form-select"></select></div>
            <div class="col-md-6"><label for="logShiftStartTime" class="form-label">Start Time</label><input type="text" id="logShiftStartTime" class="form-control flatpickr-time" placeholder="Select Time"></div>
            <div class="col-md-6"><label for="logShiftEndTime" class="form-label">End Time</label><input type="text" id="logShiftEndTime" class="form-control flatpickr-time" placeholder="Select Time"></div>
        </div>
        <div class="form-check mt-3 mb-2">
            <input class="form-check-input" type="checkbox" id="logShiftClaimTravelToggle">
            <label class="form-check-label" for="logShiftClaimTravelToggle">Claim Travel?</label>
        </div>
        <div id="logShiftKmFieldsContainer" class="row g-3 p-2 border rounded bg-light-subtle d-none">
            <div class="col-md-6"><label for="logShiftStartKm" class="form-label-sm">Start Odometer (Km):</label><input type="number" id="logShiftStartKm" class="form-control form-control-sm" placeholder="e.g., 10000.0" step="0.1" min="0"></div>
            <div class="col-md-6"><label for="logShiftEndKm" class="form-label-sm">End Odometer (Km):</label><input type="number" id="logShiftEndKm" class="form-control form-control-sm" placeholder="e.g., 10020.5" step="0.1" min="0"></div>
            <p class="mt-2 mb-0 col-12"><strong>Calculated Travel:</strong> <span id="logShiftCalculatedKm">0.0 Km</span></p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="fas fa-times me-1"></i>Cancel</button>
        <button type="button" id="saveShiftFromModalToInvoiceBtn" class="btn btn-primary"><i class="fas fa-file-import me-1"></i>Save to Invoice</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="sigModal" tabindex="-1" aria-labelledby="sigModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="sigModalLabel"><i class="fas fa-pencil-alt me-2"></i>Draw Signature</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <canvas id="signatureCanvas" class="border rounded bg-light-subtle" width="300" height="100" style="touch-action: none;"></canvas>
      </div>
      <div class="modal-footer">
        <button type="button" id="clearSigBtn" class="btn btn-outline-secondary"><i class="fas fa-eraser me-1"></i>Clear</button>
        <button type="button" id="saveSigBtn" class="btn btn-primary"><i class="fas fa-check-circle me-1"></i>Save Signature</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="wizModal" tabindex="-1" aria-labelledby="wizModalLabel" aria-hidden="true" x-data="userSetupWizard()">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="wizModalLabel" x-text="wizardTitle">Setup Progress</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="progress mb-4" style="height: 20px;">
          <div class="progress-bar" role="progressbar" :style="`width: ${currentStep / totalSteps * 100}%`" :aria-valuenow="currentStep / totalSteps * 100" aria-valuemin="0" aria-valuemax="100" x-text="`Step ${currentStep} of ${totalSteps}`"></div>
        </div>

        <div x-show="currentStep === 1">
          <h6>Step 1: Basic Info</h6>
          <div class="mb-3"><label for="wName" class="form-label">Full name</label><input id="wName" type="text" class="form-control"></div>
          <div class="mb-3"><label for="wAbn" class="form-label">ABN</label><input id="wAbn" type="text" class="form-control"></div>
          <div class="form-check mb-3"><input type="checkbox" id="wGst" class="form-check-input"><label for="wGst" class="form-check-label">GST Registered</label></div>
        </div>
        <div x-show="currentStep === 2">
          <h6>Step 2: Bank Details</h6>
          <div class="mb-3"><label for="wBsb" class="form-label">BSB</label><input id="wBsb" type="text" class="form-control"></div>
          <div class="mb-3"><label for="wAcc" class="form-label">Account number</label><input id="wAcc" type="text" class="form-control"></div>
        </div>
        <div x-show="currentStep === 3">
          <h6>Step 3: Docs (Optional)</h6>
          <div class="mb-3"><label for="wFiles" class="form-label">Upload files</label><input type="file" id="wFiles" class="form-control" multiple @change="handleWizardFiles($event)"></div>
          <div id="wFilesList" class="list-group list-group-flush mb-3">
            <template x-if="wizardFilesStaged.length === 0">
                <li class="list-group-item">No files selected.</li>
            </template>
            <template x-for="file in wizardFilesStaged" :key="file.name">
                <li class="list-group-item" x-text="`${file.name} (${(file.size / 1024).toFixed(1)} KB)`"></li>
            </template>
          </div>
        </div>
        <div x-show="currentStep === 4">
          <h6>Step 4: All Done!</h6><p>Click Finish to save your profile information.</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" @click="prevStep()" x-show="currentStep > 1"><i class="fas fa-arrow-left me-1"></i>Previous</button>
        <button type="button" class="btn btn-primary" @click="nextStep()" x-show="currentStep < totalSteps">Next<i class="fas fa-arrow-right ms-1"></i></button>
        <button type="button" id="wizFinishBtn" class="btn btn-success" @click="finishUserWizard()" x-show="currentStep === totalSteps"><i class="fas fa-check me-1"></i>Finish</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="adminSetupWizardModal" tabindex="-1" aria-labelledby="adminSetupModalLabel" aria-hidden="true" x-data="adminSetupWizard()">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="adminSetupModalLabel" x-text="wizardTitle"><i class="fas fa-magic me-2"></i>Portal Setup</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="progress mb-4" style="height: 20px;">
            <div class="progress-bar" role="progressbar" :style="`width: ${currentStep / totalSteps * 100}%`" aria-valuemin="0" aria-valuemax="100" x-text="`Step ${currentStep} of ${totalSteps}`"></div>
        </div>
        <div x-show="currentStep === 1">
            <h6>Step 1: Portal Type</h6>
            <div class="form-check"><input type="radio" name="adminWizPortalType" id="adminWizOrgType" value="organization" class="form-check-input" x-model="portalType"><label for="adminWizOrgType" class="form-check-label">Organization</label><p class="form-text text-muted small">For service providers with multiple workers.</p></div>
            <div class="form-check"><input type="radio" name="adminWizPortalType" id="adminWizIndType" value="individual_participant" class="form-check-input" x-model="portalType"><label for="adminWizIndType" class="form-check-label">Self-Managed Participant</label><p class="form-text text-muted small">For individuals managing their own supports.</p></div>
        </div>
        <div x-show="currentStep === 2">
            <h6 x-text="portalType === 'organization' ? 'Step 2: Organization Details' : 'Step 2: Your Details'"></h6>
            <div x-show="portalType === 'organization'">
                <div class="mb-3"><label for="adminWizOrgName" class="form-label">Org Name:</label><input id="adminWizOrgName" type="text" class="form-control"></div>
                <div class="mb-3"><label for="adminWizOrgAbn" class="form-label">Org ABN:</label><input id="adminWizOrgAbn" type="text" class="form-control"></div>
                <div class="mb-3"><label for="adminWizOrgContactEmail" class="form-label">Org Email:</label><input id="adminWizOrgContactEmail" type="email" class="form-control"></div>
                <div class="mb-3"><label for="adminWizOrgContactPhone" class="form-label">Org Phone:</label><input id="adminWizOrgContactPhone" type="text" class="form-control"></div>
            </div>
            <div x-show="portalType === 'individual_participant'">
                <div class="mb-3"><label for="adminWizUserName" class="form-label">Your Name (as Provider/Participant):</label><input id="adminWizUserName" type="text" class="form-control"></div>
            </div>
        </div>
        <div x-show="currentStep === 3">
            <h6>Step 3: Participant & Plan Details (for Agreements/Invoices)</h6>
            <div class="mb-3"><label for="adminWizParticipantName" class="form-label">Participant Name:</label><input id="adminWizParticipantName" type="text" class="form-control"></div>
            <div class="mb-3"><label for="adminWizParticipantNdisNo" class="form-label">NDIS No.:</label><input id="adminWizParticipantNdisNo" type="text" class="form-control"></div>
            <div class="mb-3"><label for="adminWizPlanManagerName" class="form-label">Plan Manager (if any):</label><input id="adminWizPlanManagerName" type="text" class="form-control"></div>
            <div class="mb-3"><label for="adminWizPlanManagerEmail" class="form-label">Plan Manager Email:</label><input id="adminWizPlanManagerEmail" type="email" class="form-control"></div>
            <div class="mb-3"><label for="adminWizPlanManagerPhone" class="form-label">Plan Manager Phone:</label><input id="adminWizPlanManagerPhone" type="text" class="form-control"></div>
            <div class="mb-3"><label for="adminWizPlanEndDate" class="form-label">Plan End Date:</label><input id="adminWizPlanEndDate" type="text" class="form-control flatpickr-date"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" @click="prevStep()" x-show="currentStep > 1"><i class="fas fa-arrow-left me-1"></i>Previous</button>
        <button type="button" class="btn btn-primary" @click="nextStep()" x-show="currentStep < totalSteps">Next<i class="fas fa-arrow-right ms-1"></i></button>
        <button type="button" id="adminWizFinishBtn" class="btn btn-success" @click="finishAdminWizard()" x-show="currentStep === totalSteps"><i class="fas fa-check me-1"></i>Finish Setup</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="messageModal" tabindex="-1" aria-labelledby="messageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="messageModalLabel"><i class="fas fa-info-circle me-2"></i>Alert</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p id="messageModalText"></p>
      </div>
      <div class="modal-footer">
        <button type="button" id="closeMessageModalBtn" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmationModalLabel"><i class="fas fa-question-circle me-2"></i>Confirm Action</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p id="confirmationModalText"></p>
      </div>
      <div class="modal-footer">
        <button type="button" id="confirmationModalCancelBtn" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" id="confirmationModalConfirmBtn" class="btn btn-primary">Confirm</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="travelCodeSelectionModal" tabindex="-1" aria-labelledby="travelCodeSelectionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="travelCodeSelectionModalLabel"><i class="fas fa-map-signs me-2"></i>Select Associated Travel Item Code</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Choose an NDIS service item (must be 'Travel - Per Kilometre' category) to associate as the travel code. Ensure it has a per-KM rate defined.</p>
                <div class="mb-3">
                    <label for="travelCodeFilterInput" class="form-label">Filter services:</label>
                    <input type="text" id="travelCodeFilterInput" class="form-control" placeholder="Type to filter...">
                </div>
                <div id="travelCodeListContainer" class="list-group" style="max-height: 300px; overflow-y: auto;">
                    </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="closeTravelCodeSelectionModalBtn" class="btn btn-secondary" data-bs-dismiss="modal"><i class="fas fa-times-circle me-1"></i>Cancel</button>
                <button type="button" id="confirmTravelCodeSelectionBtn" class="btn btn-primary"><i class="fas fa-check-square me-1"></i>Confirm Selection</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script type="module" src="script.js" defer></script>

</body>
</html>
